---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getBlogPageIcon } from "../../../scripts/get_icon.ts";

import {
  getBlogPageNames,
  getBlogEntriesForPage,
  selectPics,
} from "../../../scripts/select_pics.ts";

export async function getStaticPaths() {
  const pages = await getBlogPageNames();
  let paths = [];
  for (const page of pages) {
    const entries = await getBlogEntriesForPage(page);
    paths.push(
      ...entries.map((entry, index) => {
        const prev = index > 0 ? entries[index - 1] : null;
        const next = index < entries.length - 1 ? entries[index + 1] : null;
        return {
          params: { page: page.toLowerCase(), entry: entry.name.toLowerCase() },
          props: { page: page, entry: entry, prev: prev, next: next },
        };
      }),
    );
  }
  return paths;
}

const { page, entry, prev, next } = Astro.props;

const pics = await selectPics([entry.id], 2);
---
<style>
h2 {
    font-family: 'DotMatrix';
}
.scroll-container {
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  height: 600px;
  scroll-snap-type: y mandatory;
}
.img-container {
  width: 100%;
  height: 600px;
  position: relative;
}
.img-container img {
  display: flex;
  max-height: 100%;
  max-width: 100%;
  /* width: auto; */
  margin-left: auto; 
  margin-right: auto;
  border-radius: 1.5em;
  scroll-snap-align: start;
}
.text-caption {
  background: rgba(0.4, 0.4, 0.4, 0.7);
  padding: 1em;
  color: white;
  position: absolute;
  bottom: 2em;
  width: fit-content;
  max-width: 80%;
  left: 0;
  right: 0;
  margin-inline: auto;
  border-radius: 0.5em;
}
.text-caption p {
  margin: 0;
}
</style>

<BaseLayout title={entry.name} icon={getBlogPageIcon(page)} >
  <h2>{entry.section}</h2>
  <h3>{new Date(entry.date!).toLocaleDateString()}
    {entry.caption && <>{" - "} {entry.caption}</>}
  </h3>
  <p style="display: flex; align-items: center; justify-content: space-between;">
    <a
      class="redlink"
      href={`/photoblog/${(page as string).toLowerCase()}`}
    >
      &lt;-- zurück
    </a>
    <span>
      { prev && 
        <a
          class="redlink"
          style="margin-right: 1em;"
          href=`/photoblog/${(page as string).toLowerCase()}/${prev.name.toLowerCase()}`
        >
          &lt;- vorheriger Eintrag
        </a>
      }
      { next && 
        <a
          class="redlink"
          href=`/photoblog/${(page as string).toLowerCase()}/${next.name.toLowerCase()}`
        >
          nächster Eintrag -&gt;
        </a>
      }
    </span>
  </p>
  <div class="scroll-container">
    { pics.map((pic) => 
      <div class="img-container">
        <img src={pic.path} title={pic.title}) />
        {pic.caption && <div class="text-caption"><p>{pic.caption}</p></div>}
      </div>)
    }
  </div>
</BaseLayout>
